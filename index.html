<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAR GROUNDS | Final Mobile & Desktop</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --m-green: #4b5320; --orange: #ff8c00; --red: #8b0000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Roboto Mono', monospace; touch-action: none; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; }

        /* ORIENTATION LOCK */
        #rotate-warning { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0e0e0e; color: #fff; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        @media screen and (orientation: portrait) { #rotate-warning { display: flex; } }

        /* UI SCREENS */
        .screen { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; background: rgba(0,0,0,0.85); color: white; }
        .card { background: #fff; color: #000; padding: 25px; border: 5px solid var(--m-green); width: 60%; max-width: 450px; text-align: center; box-shadow: 0 0 20px rgba(0,255,0,0.2); }
        .btn { width: 100%; padding: 15px; margin-top: 10px; background: var(--m-green); color: white; border: none; font-family: 'Black Ops One'; font-size: 18px; cursor: pointer; }

        /* HUD & GAMEPLAY */
        #crosshair { position: fixed; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid #00ff00; border-radius: 50%; transform: translate(-50%, -50%); z-index: 100; display: none; pointer-events: none; }
        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; display: none; justify-content: space-between; pointer-events: none; z-index: 100; box-sizing: border-box; }
        .hud-box { background:rgba(0,0,0,0.7); color: #00ff00; padding:10px; border:1px solid #00ff00; font-weight:bold; }
        #hp-bar { width: 120px; height: 12px; background: #333; border: 1px solid #00ff00; margin-top:5px; }
        #hp-fill { width: 100%; height: 100%; background: #00ff00; }

        #hotbar { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: none; gap: 8px; z-index: 1000; }
        .slot { width: 50px; height: 50px; background: rgba(0,0,0,0.8); border: 2px solid #555; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 8px; cursor: pointer; }
        .slot.active { border-color: #00ff00; background: rgba(0,255,0,0.2); transform: scale(1.1); }

        /* MOBILE JOYSTICK & BUTTONS */
        #mobile-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 500; }
        #joy-zone { position: absolute; bottom: 30px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.05); border: 2px solid #00ff00; border-radius: 50%; pointer-events: auto; }
        #joy-knob { position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; background: #00ff00; border-radius: 50%; }
        .act-btn { position: absolute; border-radius: 50%; font-family: 'Black Ops One'; display: flex; justify-content: center; align-items: center; pointer-events: auto; color: white; user-select: none; }
        #btn-f { bottom: 30px; right: 30px; background: var(--red); width: 90px; height: 90px; font-size: 20px; box-shadow: 0 0 15px var(--red); }
        #btn-j { bottom: 130px; right: 45px; background: #333; width: 60px; height: 60px; border: 1px solid #777; font-size: 12px; }
    </style>
</head>
<body>

<div id="rotate-warning">
    <h1 style="font-family:'Black Ops One';">ROTATE DEVICE</h1>
    <p>Please use landscape mode to play.</p>
</div>

<div id="auth-overlay" class="screen" style="display: flex;">
    <div class="card">
        <h2 style="font-family: 'Black Ops One'; color: var(--m-green);">WAR GROUNDS</h2>
        <input type="email" id="email" placeholder="EMAIL" style="width:100%; padding:10px; margin:5px 0;">
        <input type="password" id="pass" placeholder="PASSWORD" style="width:100%; padding:10px; margin:5px 0;">
        <button class="btn" id="login-btn">ENLIST</button>
    </div>
</div>

<div id="main-menu" class="screen">
    <div class="card">
        <h2 id="user-tag" style="font-size:14px;"></h2>
        <button class="btn" id="deploy-btn">DEPLOY</button>
        <div id="l-board" style="background:#eee; margin-top:10px; padding:10px; font-size:12px; text-align:left; color:#000;">
            <p style="text-align:center; font-weight:bold; margin:0;">RANKINGS</p>
            <div id="l-entries"></div>
        </div>
    </div>
</div>

<div id="crosshair"></div>
<div id="hud">
    <div class="hud-box">SCORE: <span id="score-val">0</span><br>HP <div id="hp-bar"><div id="hp-fill"></div></div></div>
    <div class="hud-box">AMMO: <span id="ammo-val">30</span></div>
</div>

<div id="hotbar">
    <div class="slot active" onclick="selectSlot(0)">1<span>RIFLE</span></div>
    <div class="slot" onclick="selectSlot(1)">2<span>PISTOL</span></div>
    <div class="slot" onclick="selectSlot(2)">3<span>SMG</span></div>
    <div class="slot" onclick="selectSlot(3)">4<span>MEDKIT</span></div>
    <div class="slot" onclick="selectSlot(4)">5<span>FRAG</span></div>
</div>

<div id="mobile-ui">
    <div id="joy-zone"><div id="joy-knob"></div></div>
    <div id="btn-f" class="act-btn">FIRE</div>
    <div id="btn-j" class="act-btn">JUMP</div>
</div>

<div id="game-over" class="screen">
    <h1 style="color:var(--red); font-family:'Black Ops One'; font-size: 70px;">K.I.A.</h1>
    <button class="btn" style="width:250px;" onclick="location.reload()">RE-DEPLOY</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/PointerLockControls.js"></script>

<script>
    let scene, camera, renderer, controls, raycaster;
    let isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    let moveF=0, moveB=0, moveL=0, moveR=0, canJump=false, velocity = new THREE.Vector3(), direction = new THREE.Vector3();
    let score=0, health=100, isGameOver=false, enemies=[], collidables=[], weapons = [];
    let weaponContainer, ammo = [30, 15, 45, 3, 5], currentSlot = 0, recoilAmt = 0, prevTime = performance.now();

    // Procedural Texture Engine
    function genTexture(c1, c2, mode) {
        const canv = document.createElement('canvas'); canv.width = canv.height = 256;
        const ctx = canv.getContext('2d'); ctx.fillStyle = c1; ctx.fillRect(0,0,256,256);
        ctx.fillStyle = c2;
        if(mode==='grid'){ for(let i=0; i<256; i+=32){ ctx.fillRect(i,0,1,256); ctx.fillRect(0,i,256,1); } }
        else { for(let i=0; i<800; i++) ctx.fillRect(Math.random()*256, Math.random()*256, 3, 3); }
        const t = new THREE.CanvasTexture(canv); t.wrapS = t.wrapT = THREE.RepeatWrapping; return t;
    }

    window.onload = () => { if(localStorage.getItem('wg_session')) showLobby(localStorage.getItem('wg_session')); };

    document.getElementById('login-btn').onclick = () => {
        const e = document.getElementById('email').value; if(!e) return;
        let db = JSON.parse(localStorage.getItem('wg_db')) || [];
        if(!db.find(x => x.email === e)) db.push({email:e, score:0});
        localStorage.setItem('wg_db', JSON.stringify(db)); localStorage.setItem('wg_session', e); showLobby(e);
    };

    function showLobby(email) {
        document.querySelectorAll('.screen').forEach(s => s.style.display='none');
        document.getElementById('main-menu').style.display='flex';
        document.getElementById('user-tag').innerText = "OPERATOR: " + email.toUpperCase();
        const db = JSON.parse(localStorage.getItem('wg_db')) || [];
        const top = db.sort((a,b) => b.score - a.score).slice(0, 5);
        document.getElementById('l-entries').innerHTML = top.map((u,i)=>`<div>${i+1}. ${u.email.split('@')[0]} - ${u.score}</div>`).join('');
        if(!scene) init();
    }

    function init() {
        scene = new THREE.Scene(); scene.background = new THREE.Color(0x050505);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
        renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); document.body.appendChild(renderer.domElement);
        controls = new THREE.PointerLockControls(camera, document.body); scene.add(controls.getObject()); controls.getObject().position.set(0, 12, 0);

        // Map
        const gTex = genTexture('#111', '#004400', 'grid'); gTex.repeat.set(100,100);
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(4000, 4000), new THREE.MeshStandardMaterial({map: gTex}));
        ground.rotation.x = -Math.PI/2; scene.add(ground);
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));

        const objTex = genTexture('#4b5320', '#2d3312', 'noise');
        for(let i=0; i<90; i++) {
            const x = (Math.random()-0.5)*2000, z = (Math.random()-0.5)*2000;
            if(Math.abs(x)<100 && Math.abs(z)<100) continue;
            let m, r;
            if(Math.random()>0.4){ 
                m=new THREE.Mesh(new THREE.BoxGeometry(20,20,20), new THREE.MeshStandardMaterial({map:objTex})); 
                m.position.set(x,10,z); r=14; 
            } else { 
                m=new THREE.Mesh(new THREE.CylinderGeometry(5,5,80,8), new THREE.MeshStandardMaterial({map:objTex})); 
                m.position.set(x,40,z); r=8; 
            }
            scene.add(m); collidables.push({x, z, rad: r});
        }

        // Weaponry
        weaponContainer = new THREE.Group(); camera.add(weaponContainer);
        const wMat = new THREE.MeshStandardMaterial({color:0x1a1a1a});
        weapons.push(new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 3), wMat)); // Rifle
        weapons.push(new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.3, 1), wMat)); // Pistol
        weapons.push(new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 2), wMat)); // SMG
        weapons.push(new THREE.Mesh(new THREE.BoxGeometry(1, 0.8, 0.8), new THREE.MeshStandardMaterial({color:0xffffff}))); 
        weapons.push(new THREE.Mesh(new THREE.SphereGeometry(0.4, 10, 10), new THREE.MeshStandardMaterial({color:0x4b5320}))); 
        weapons.forEach((w,i)=>{ w.position.set(1.1, -1, -2); w.visible=(i===0); weaponContainer.add(w); });

        raycaster = new THREE.Raycaster();

        document.getElementById('deploy-btn').onclick = () => {
            if(!isTouch) controls.lock();
            document.getElementById('main-menu').style.display='none';
            ['hud', 'hotbar', 'crosshair'].forEach(id => document.getElementById(id).style.display='flex');
            if(isTouch) document.getElementById('mobile-ui').style.display='block';
        };

        // Input Setup
        document.addEventListener('keydown', (e) => {
            if(e.code==='KeyW') moveF=1; if(e.code==='KeyS') moveB=1; if(e.code==='KeyA') moveL=1; if(e.code==='KeyD') moveR=1;
            if(e.code==='Space' && canJump){ velocity.y+=250; canJump=false; }
            if(['Digit1','Digit2','Digit3','Digit4','Digit5'].includes(e.code)) selectSlot(parseInt(e.key)-1);
        });
        document.addEventListener('keyup', (e) => {
            if(e.code==='KeyW') moveF=0; if(e.code==='KeyS') moveB=0; if(e.code==='KeyA') moveL=0; if(e.code==='KeyD') moveR=0;
        });
        window.addEventListener('mousedown', () => { if(!isGameOver && (controls.isLocked || isTouch)) shoot(); });

        if(isTouch) setupMobile();
        animate();
    }

    function selectSlot(i) {
        currentSlot=i; weapons.forEach((w,idx)=>w.visible=(idx===i));
        document.querySelectorAll('.slot').forEach((s,idx)=>s.classList.toggle('active', idx===i));
        document.getElementById('ammo-val').innerText = ammo[i];
    }

    function shoot() {
        if(ammo[currentSlot]<=0) return;
        if(currentSlot===3) { // Medkit
            if(health<100) { health=Math.min(100, health+20); ammo[3]--; selectSlot(3); document.getElementById('hp-fill').style.width=health+"%"; }
            return;
        }
        ammo[currentSlot]--; document.getElementById('ammo-val').innerText = ammo[currentSlot]; recoilAmt=0.35;
        raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
        const hits = raycaster.intersectObjects(enemies);
        if(hits.length>0) { scene.remove(hits[0].object); enemies=enemies.filter(e=>e!==hits[0].object); score+=100; document.getElementById('score-val').innerText=score; }
    }

    function setupMobile() {
        const knob = document.getElementById('joy-knob'), zone = document.getElementById('joy-zone');
        zone.addEventListener('touchmove', (e) => {
            e.preventDefault(); const t=e.touches[0], r=zone.getBoundingClientRect();
            const dx=t.clientX-(r.left+55), dy=t.clientY-(r.top+55);
            const dist=Math.min(45, Math.sqrt(dx*dx+dy*dy)), ang=Math.atan2(dy, dx);
            knob.style.transform=`translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
            moveF=dy<-15?1:0; moveB=dy>15?1:0; moveL=dx<-15?1:0; moveR=dx>15?1:0;
        });
        zone.addEventListener('touchend', () => { knob.style.transform='none'; moveF=moveB=moveL=moveR=0; });
        let lx, ly;
        window.addEventListener('touchmove', (e) => {
            const t=e.touches[0]; if(t.clientX>window.innerWidth/2){
                if(lx){ camera.rotation.y-=(t.clientX-lx)*0.006; camera.rotation.x-=(t.clientY-ly)*0.006; camera.rotation.x=Math.max(-1.5, Math.min(1.5, camera.rotation.x)); }
                lx=t.clientX; ly=t.clientY;
            }
        });
        document.getElementById('btn-f').ontouchstart=(e)=>{ e.preventDefault(); shoot(); };
        document.getElementById('btn-j').ontouchstart=(e)=>{ e.preventDefault(); if(canJump){velocity.y+=250; canJump=false;} };
    }

    function animate() {
        requestAnimationFrame(animate); const time=performance.now(), delta=(time-prevTime)/1000;
        if(!isGameOver && (controls.isLocked || isTouch)) {
            velocity.x-=velocity.x*10*delta; velocity.z-=velocity.z*10*delta; velocity.y-=9.8*80*delta;
            direction.z=Number(moveF)-Number(moveB); direction.x=Number(moveL)-Number(moveR); direction.normalize();
            if(moveF||moveB) velocity.z-=direction.z*750*delta; if(moveL||moveR) velocity.x-=direction.x*750*delta;
            controls.moveRight(-velocity.x*delta); controls.moveForward(-velocity.z*delta);
            
            // Collision Logic
            const pos = controls.getObject().position;
            collidables.forEach(c => {
                const dx=pos.x-c.x, dz=pos.z-c.z, dist=Math.sqrt(dx*dx+dz*dz);
                if(dist<c.rad+6) { const a=Math.atan2(dz,dx); pos.x=c.x+Math.cos(a)*(c.rad+6); pos.z=c.z+Math.sin(a)*(c.rad+6); }
            });
            pos.y+=velocity.y*delta; if(pos.y<12){ velocity.y=0; pos.y=12; canJump=true; }
            weaponContainer.position.set(0, -recoilAmt, recoilAmt*2); recoilAmt*=0.85;

            // Enemy Spawn & AI
            if(Math.random()<0.008) {
                const en=new THREE.Mesh(new THREE.BoxGeometry(16,25,16), new THREE.MeshStandardMaterial({map:genTexture('#400','#f00','noise')}));
                const a=Math.random()*Math.PI*2; en.position.set(Math.cos(a)*900,12.5,Math.sin(a)*900); scene.add(en); enemies.push(en);
            }
            enemies.forEach(e=>{
                const v=new THREE.Vector3().subVectors(camera.position, e.position).normalize();
                e.position.x+=v.x*95*delta; e.position.z+=v.z*95*delta;
                if(e.position.distanceTo(camera.position)<25){
                    health-=0.8; document.getElementById('hp-fill').style.width=health+"%";
                    if(health<=0){ 
                        isGameOver=true; document.getElementById('game-over').style.display='flex'; 
                        controls.unlock(); document.exitPointerLock(); 
                        let db = JSON.parse(localStorage.getItem('wg_db')); 
                        const u = db.find(x => x.email === localStorage.getItem('wg_session'));
                        if(u && score > u.score) u.score = score; localStorage.setItem('wg_db', JSON.stringify(db));
                    }
                }
            });
        }
        renderer.render(scene, camera); prevTime=time;
    }
</script>
</body>
</html>